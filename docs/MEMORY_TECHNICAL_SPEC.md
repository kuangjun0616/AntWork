# 记忆能力技术方案（流程与概念）

本文档从**流程与概念**层面说明 AICowork 的记忆能力：对话如何发现并调用记忆 MCP、记忆如何检索、标题为何作为索引、存储介质是什么、为何能在对话中通过 MCP 存储记忆。不涉及具体代码与文件路径。

---

## 一、记忆存的是什么、放在哪里？

**存储介质**：既不是 Markdown 文件，也不是传统数据库，而是**应用数据目录下的 JSON 文件**。

- 应用在本地维护一个「记忆目录」，其中有两类数据：
  - **种类**：用户自定义的分类（如「偏好」「项目决策」「待办」），每条记忆必须属于某一个种类。
  - **条目**：单条记忆，包含**标题**、**正文**、所属种类、重要性、时间等。
- 种类与条目都以**结构化数据**形式保存在该目录中（可理解为两份列表：种类列表、条目列表），便于程序按条件筛选和排序，也便于设置页与对话中的 MCP 共用同一份数据。

**要点**：所有记忆（无论来自设置页手动添加，还是对话中由模型通过 MCP 写入）都写入同一套数据；设置页与对话侧看到的是同一份记忆。

---

## 二、对话是如何「发现」要调用记忆 MCP 的？

**流程概览**：

1. **会话启动时**  
   用户发起或恢复一次对话时，应用在启动「对话引擎」的同时，会加载当前可用的所有 MCP 服务，其中**固定包含一个内置的「记忆 MCP」**（与用户在设置里配置的其他 MCP 一起加载）。  
   也就是说：只要进入对话，记忆 MCP 已经被挂载到本次会话里，不需要用户再单独打开或配置。

2. **工具列表下发给模型**  
   对话引擎会把当前已加载的 MCP 所提供的「工具」汇总成一份列表，随会话一起提供给大模型。  
   这份列表里就包含记忆 MCP 提供的三个能力：**回忆（按条件查记忆）**、**存储（写一条新记忆）**、**遗忘（删一条记忆）**，并带有每个能力的简短说明（例如：回忆——按关键词或种类检索记忆；存储——把一段内容记下来，建议带标题等）。

3. **模型根据用户意图决定是否调用**  
   用户说「查一下我的工号」「记住：我偏好深色模式」「忘掉刚才那条关于 API 的」时，模型根据语义判断这与「记忆」相关，再从工具列表里选择「回忆 / 存储 / 遗忘」中的某一个，并填入相应参数（如关键词、要记的内容、要删的哪一条）发起调用。  
   因此，「发现要调用记忆 MCP」的本质是：**会话一开始记忆 MCP 就已在工具列表中；模型根据当前用户输入，决定是否使用「回忆 / 存储 / 遗忘」这三个工具之一**。

**小结**：对话并不需要单独「发现」记忆 MCP，而是会话启动时记忆 MCP 就已经作为可选工具之一提供给模型；模型在理解用户意图后，从已有工具里选择记忆相关的工具并调用。

---

## 三、记忆 MCP 是如何检索记忆的？

**流程**：

1. 用户或模型在对话中表达「查一下和 xxx 有关的记忆」时，模型会调用「回忆」工具，并传入**检索条件**（例如：关键词「工号」、可选种类、最多返回条数等）。

2. 记忆 MCP 收到这次调用后，会去读**同一套记忆数据**（即与设置页完全一致的那份种类与条目数据），然后：
   - 只保留未删除的条目；
   - 若指定了种类，则只保留该种类下的条目；
   - 若有关键词，则在**标题**和**正文**中做**关键词匹配**（包含即视为命中）；
   - 若有多个命中，会**优先把「标题里含该关键词」的条目排前面**，其余按更新时间排序；
   - 按「最多返回 N 条」截断后，把结果整理成一段可读文字返回给模型。

3. 模型把这段文字纳入自己的回复，用户就看到「查到的记忆」了。

**小结**：记忆 MCP 的检索是**读同一份记忆数据 + 按关键词/种类过滤 + 标题匹配优先排序**，没有单独的搜索引擎或数据库索引，就是基于「标题 + 正文」的文本匹配和简单排序。

---

## 四、为什么说「标题是索引」？通过索引是怎么检索的？

**概念说明**：

- 这里的「索引」**不是**数据库里的 B 树或倒排索引，而是指：**检索时优先用「标题」来匹配和排序，标题相当于这条记忆的「门牌号」或「关键词标签」**。
- 每条记忆有两个与检索相关的部分：
  - **标题**：用户（或模型）填的简短概括，如「张三的工号」「API 选型决策」。  
  - **正文**：完整内容，可能较长。

**为何把标题当「索引」用？**

- 检索时用户或模型往往用**短词**提问（如「工号」「API」）。  
  若只在长正文里匹配，可能命中很多无关句子；若**先看标题**，标题本身就是提炼过的关键词，匹配「工号」更容易命中「张三的工号」这条记忆。  
  因此设计成：**检索时既匹配标题也匹配正文，但「标题里含关键词」的条目会排在前面**，这样更符合「用标题当门牌号」的直觉。
- 在设置里，我们要求用户为每条记忆**必填标题**，就是为了让每条记忆都有这样一个「门牌号」，方便后续用简短关键词在对话里召回。

**「通过索引检索」在流程上是什么？**

- 用户或模型给出**关键词**（如「工号」）；
- 系统在所有记忆的**标题**和**正文**里做**包含**判断；
- 标题命中的条目排在前面，正文命中、标题未命中的排在后面；
- 再按时间等规则排序后返回。  

所以「通过索引检索」= **用关键词在「标题 + 正文」上做匹配，并优先展示标题命中的那条**。

---

## 五、为什么在对话中可以通过 MCP「存储」记忆？

**流程**：

1. 用户在对话里说「记住：我偏好用 TypeScript」或「把张三的工号 12345 记下来」时，模型会从工具列表里选择「存储」工具，并填入：
   - 要记的**正文**（必填）；
   - 可选：**标题**（强烈建议，便于以后用「工号」「偏好」等词检索）；
   - 可选：种类、重要性等。

2. 记忆 MCP 收到「存储」调用后，会向**同一套记忆数据**里**追加一条新条目**（包含标题、正文、种类、时间等），并写回存储。  
   也就是说：**对话里「存」下来的记忆，和设置页里手动添加的记忆，写在同一个地方、同一种结构**。

3. 之后无论是：
   - 在设置页打开「记忆」查看/编辑，还是  
   - 在对话里说「查一下我的偏好」「回忆和工号有关的」，  

都会读同一份数据，因此**对话中通过 MCP 存的记忆，会立刻出现在设置页；设置页添加或修改的记忆，也会在对话的「回忆」结果里出现**。

**小结**：对话中能通过 MCP 存储记忆，是因为记忆 MCP 不仅提供「回忆」，还提供「存储」工具；存储时写入的是与设置页共用的同一套记忆数据，所以一次写入、两处可见（设置页 + 对话回忆）。

---

## 六、整体流程串起来（不涉及实现细节）

1. **会话开始**  
   应用加载所有 MCP（含内置记忆 MCP），把工具列表（含「回忆 / 存储 / 遗忘」）交给模型。

2. **用户说「查一下工号」**  
   模型调用「回忆」，传入关键词「工号」 → 记忆 MCP 读记忆数据，在标题和正文中匹配「工号」，标题命中的排前 → 返回匹配条目摘要 → 模型把结果组织成自然语言回复给用户。

3. **用户说「记住：我偏好深色模式」**  
   模型调用「存储」，传入正文和标题（如「偏好深色模式」）→ 记忆 MCP 向同一套记忆数据追加一条 → 写回存储；之后在设置页或对话里都能查到这条记忆。

4. **记忆数据存在哪里、什么形式**  
   存在应用本地的记忆目录中，以结构化数据形式保存（可理解为「种类列表 + 条目列表」），不是 .md 文件也不是独立数据库；设置页与记忆 MCP 都读写这份数据，因此始终一致。

5. **「标题是索引」的含义**  
   标题是用户为每条记忆起的短名；检索时用关键词同时匹配标题和正文，且**标题命中的优先展示**，这就是「通过标题做索引」的流程含义。

---

以上从流程与概念层面回答了：对话如何发现并调用记忆 MCP、记忆 MCP 如何检索、标题为何作为索引及如何通过它检索、记忆的存储介质、以及为何能在对话中通过 MCP 存储记忆。不涉及具体代码与文件结构。
