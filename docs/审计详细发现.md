# AICowork 审计详细发现

按审计组分类的详细问题列表。

---

## T-01: Electron 主进程核心文件

### Critical (2)

#### C-01-01: BrowserWindow 安全配置缺失
- **文件**: `src/electron/main/window-manager.ts:29`
- **CWE**: CWE-924
- **代码**:
```typescript
webPreferences: {
    preload: getPreloadPath(),
    devTools: true,
},
```
- **修复**: 添加 `contextIsolation: true`, `sandbox: true`, `nodeIntegration: false`

#### C-01-02: 应用菜单关闭风险
- **文件**: `src/electron/main.ts:65`
- **CWE**: CWE-269
- **代码**:
```typescript
Menu.setApplicationMenu(null);
```
- **修复**: 保留基本菜单项如 File > Exit

### High (7)

#### H-01-01: 外部 URL 打开缺少验证
- **文件**: `src/electron/main/ipc-registry.ts:142`
- **CWE**: CWE-22
- **修复**: 添加 URL 白名单验证

#### H-01-02: API 配置类型安全
- **文件**: `src/electron/main/ipc-registry.ts:233,250`
- **CWE**: CWE-287
- **修复**: 定义 ApiConfig 接口，添加运行时验证

#### H-01-03: 命令注入风险
- **文件**: `src/electron/main/lifecycle.ts:66,68`
- **CWE**: CWE-78
- **修复**: 使用 child_process.spawn 或端口管理库

#### H-01-04: CSP 配置过于宽松
- **文件**: `src/electron/main/window-manager.ts:73`
- **CWE**: CWE-924
- **修复**: 移除 unsafe-inline 和 unsafe-eval

#### H-01-05: 生产环境启用 devTools
- **文件**: `src/electron/main/window-manager.ts:31`
- **CWE**: CWE-924
- **修复**: 根据环境变量动态控制

#### H-01-06: any 类型使用 (多处)
- **文件**: `src/electron/ipc-handlers.ts:117,135`
- **CWE**: CWE-605
- **修复**: 定义具体类型

#### H-01-07: 文件监听器资源泄漏
- **文件**: `src/electron/main/ipc-registry.ts:348`
- **CWE**: CWE-404
- **修复**: 添加 unhandledRejection 处理

---

## T-02: 错误处理和类型系统

### Critical (1)

#### C-02-01: API 响应体泄露敏感信息
- **文件**: `src/electron/errors/api-error.ts:97`
- **CWE**: CWE-532, CWE-312
- **代码**:
```typescript
responseBody?: string;  // 存储完整响应
```
- **修复**: 移除或脱敏处理

### High (3)

#### H-02-01: 上下文信息序列化泄露
- **文件**: `src/electron/errors/handler.ts:106`
- **CWE**: CWE-312
- **修复**: 实现安全序列化

#### H-02-02: 会话错误信息直接暴露
- **文件**: `src/electron/handlers/session-handlers.ts:107`
- **CWE**: CWE-269
- **修复**: 脱敏处理

#### H-02-03: Promise toString() 泄露
- **文件**: `src/electron/error-handling.ts:11`
- **CWE**: CWE-532
- **修复**: 不记录 Promise.toString()

---

## T-03: API 适配器层

### Critical (2)

#### C-03-01: API 密钥明文处理
- **文件**: `src/electron/libs/api-adapter.ts:25`
- **CWE**: CWE-311
- **代码**:
```typescript
'x-api-key': config.apiKey,
```
- **修复**: 使用加密存储和日志过滤

#### C-03-02: Authorization 头部泄露
- **文件**: `src/electron/libs/api-adapters/openai-adapter.ts:55`
- **CWE**: CWE-311
- **代码**:
```typescript
'Authorization': `Bearer ${config.apiKey}`,
```
- **修复**: 实现安全处理

### High (5)

#### H-03-01: JSON.parse 无错误处理
- **文件**: `src/electron/libs/api-adapters/openai-adapter.ts:95`
- **CWE**: CWE-20
- **修复**: 添加 try-catch

#### H-03-02: 代理服务器请求验证缺失
- **文件**: `src/electron/api-proxy/server.ts:62`
- **CWE**: CWE-287
- **修复**: 添加请求来源验证

#### H-03-03: CORS 配置过于宽松
- **文件**: `src/electron/api-proxy/server.ts:38`
- **CWE**: CWE-942
- **代码**:
```typescript
res.setHeader('Access-Control-Allow-Origin', '*');
```
- **修复**: 限制特定域名

#### H-03-04: 请求日志泄露敏感信息
- **文件**: `src/electron/api-proxy/server.ts:204`
- **CWE**: CWE-532
- **修复**: 过滤敏感字段

#### H-03-05: 请求未设置超时
- **文件**: `src/electron/api-proxy/server.ts:207`
- **CWE**: CWE-400
- **修复**: 添加 timeout 参数

---

## T-04: Runner 核心模块

### High (5)

#### H-04-01: 权限模式绕过风险
- **文件**: `src/electron/libs/runner/index.ts:150`
- **CWE**: CWE-287
- **代码**:
```typescript
const permissionMode = hasExplicitPermissions ? "default" : "acceptEdits";
```
- **修复**: 使用严格默认模式

#### H-04-02: 自动批准机制过于宽松
- **文件**: `src/electron/libs/runner/permission-handler.ts:81`
- **CWE**: CWE-287
- **修复**: 实现白名单机制

#### H-04-03: 日志包含敏感信息
- **文件**: `src/electron/libs/runner/permission-handler.ts:34`
- **CWE**: CWE-532
- **代码**:
```typescript
log.info(`[Tool] Bash command: ${cmd}`);
```
- **修复**: 过滤敏感命令参数

#### H-04-04: JSON 注入风险
- **文件**: `src/electron/libs/runner/memory-manager.ts:210`
- **CWE**: CWE-502
- **修复**: 验证 JSON 结构

#### H-04-05: SDK 配置注入
- **文件**: `src/electron/libs/runner/index.ts:128`
- **CWE**: CWE-915
- **修复**: 验证配置完整性

---

## T-05: 存储层

### High (4)

#### H-05-01: API 密钥明文存储
- **文件**: `src/electron/storage/config-store.ts:721`
- **CWE**: CWE-311
- **修复**: 使用加密存储

#### H-05-02: 数据库路径验证缺失
- **文件**: `src/electron/storage/session-store.ts:45`
- **CWE**: CWE-22
- **修复**: 验证数据库路径

#### H-05-03: 子进程命令注入
- **文件**: `src/electron/storage/mcp-store.ts:354`
- **CWE**: CWE-78
- **代码**:
```typescript
const child = spawn(command, args, {
  shell: true,
});
```
- **修复**: 移除 shell: true

#### H-05-04: 临时目录访问
- **文件**: `src/electron/storage/memvid-store.ts:125`
- **CWE**: CWE-26
- **修复**: 限制访问范围

---

## T-06: 工具和实用程序

### High (1)

#### H-06-01: 环境变量信任度过高
- **文件**: `src/electron/services/claude-settings.ts:73`
- **CWE**: CWE-862
- **修复**: 验证环境变量内容

### Medium (5)

#### M-06-01: 路径验证不完整
- **文件**: `src/electron/utils/claude-memory-tool.ts:180`
- **CWE**: CWE-22
- **修复**: 使用路径规范化

#### M-06-02: MCP 请求验证不足
- **文件**: `src/electron/utils/memory-mcp-server.ts:82`
- **CWE**: CWE-20
- **修复**: 添加参数验证

#### M-06-03: 日志敏感信息
- **文件**: `src/electron/utils/claude-memory-tool.ts:54`
- **CWE**: CWE-532
- **修复**: 过滤敏感路径

#### M-06-04: 命令执行安全
- **文件**: `src/electron/utils/platform.ts:47`
- **CWE**: CWE-78
- **修复**: 验证命令参数

#### M-06-05: 配置未验证加载
- **文件**: `src/electron/utils/sdk-native-loader.ts:110`
- **CWE**: CWE-642
- **修复**: 验证配置完整性

---

## T-07: UI 组件和页面

### High (3)

#### H-07-01: XSS 风险 (Markdown)
- **文件**: `src/ui/render/markdown.tsx`
- **CWE**: CWE-79
- **修复**: 添加 rehype-sanitize

#### H-07-02: 脚本注入 (图表)
- **文件**: `src/ui/render/markdown-enhanced.tsx:102`
- **CWE**: CWE-94
- **修复**: 沙箱执行

#### H-07-03: 输入验证不足
- **文件**: 多个组件
- **CWE**: CWE-20
- **修复**: 添加输入验证

---

## T-08: UI 配置和工具

### Critical (2)

#### C-08-01: dangerouslySetInnerHTML 使用
- **文件**: `src/ui/render/markdown-enhanced.tsx:102`
- **CWE**: CWE-79
- **代码**:
```typescript
<div dangerouslySetInnerHTML={{ __html: safeHtml }} />
```
- **修复**: 使用 DOMPurify

#### C-08-02: Mermaid 代码注入
- **文件**: `src/ui/render/markdown-enhanced.tsx:215`
- **CWE**: CWE-94
- **修复**: iframe 沙箱

### High (2)

#### H-08-01: IPC 输入验证缺失
- **文件**: `src/ui/hooks/useIPC.ts:45`
- **CWE**: CWE-20
- **修复**: 验证 payload

#### H-08-02: localStorage 未加密
- **文件**: `src/ui/hooks/useAppStore.ts:128`
- **CWE**: CWE-311
- **修复**: 实现加密存储

---

## T-09: 共享代码和配置

### High (2)

#### H-09-01: SDK 已知漏洞
- **文件**: `package.json`
- **CVE**: CVE-2024-41112 (可能)
- **包**: @anthropic-ai/claude-agent-sdk@0.2.12
- **修复**: 升级到 0.2.17

#### H-09-02: 工具权限验证不足
- **文件**: `src/electron/libs/runner/index.ts:148`
- **CWE**: CWE-862
- **修复**: 添加白名单检查

### Medium (2)

#### M-09-01: TypeScript 严格模式禁用
- **文件**: `src/electron/tsconfig.json`
- **CWE**: CWE-416
- **修复**: 启用严格模式

#### M-09-02: asarUnpack 范围过大
- **文件**: `electron-builder.json`
- **CWE**: CWE-922
- **修复**: 最小化解包范围

---

## 修复检查清单

### Critical 问题 (必须立即修复)

- [ ] C-01-01: BrowserWindow 安全配置
- [ ] C-01-02: 应用菜单保留基本功能
- [ ] C-02-01: API 响应体脱敏
- [ ] C-03-01: API 密钥加密存储
- [ ] C-03-02: Authorization 头部安全处理
- [ ] C-08-01: dangerouslySetInnerHTML 替换
- [ ] C-08-02: Mermaid 沙箱执行

### High 问题 (2周内修复)

- [ ] H-01-01 到 H-01-07: 主进程安全问题
- [ ] H-02-01 到 H-02-03: 错误处理安全
- [ ] H-03-01 到 H-03-05: API 适配器安全
- [ ] H-04-01 到 H-04-05: Runner 权限安全
- [ ] H-05-01 到 H-05-04: 存储层安全
- [ ] H-06-01: 环境变量验证
- [ ] H-07-01 到 H-07-03: UI XSS 防护
- [ ] H-08-01 到 H-08-02: UI 数据保护
- [ ] H-09-01 到 H-09-02: 依赖和配置安全

### Medium 问题 (1个月内修复)

- [ ] M-06-01 到 M-06-05: 工具类改进
- [ ] M-09-01 到 M-09-02: 配置优化

---

**审计完成时间**: 2026-01-23
**审计文件数**: 139
**发现问题数**: 91
