# AICowork 架构设计文档

> 版本：0.1.0
> 最后更新：2026-01-23

---

## 目录

1. [系统概述](#系统概述)
2. [架构设计原则](#架构设计原则)
3. [分层架构](#分层架构)
4. [数据流设计](#数据流设计)
5. [核心模块架构](#核心模块架构)
6. [存储架构](#存储架构)
7. [安全设计](#安全设计)
8. [性能优化](#性能优化)
9. [扩展性设计](#扩展性设计)

---

## 系统概述

### 整体架构图

```
┌──────────────────────────────────────────────────────────────────┐
│                         AICowork 应用                             │
│  ┌─────────────────────────────────────────────────────────────┐  │
│  │                    Electron 主进程层                         │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    │  │
│  │  │ API 代理 │  │ 会话管理 │  │ 存储层   │  │ 日志系统 │    │  │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘    │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    │  │
│  │  │配置管理  │  │ MCP 集成 │  │ 技能系统 │  │ 代理系统 │    │  │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘    │  │
│  └─────────────────────────────────────────────────────────────┘  │
│                           ↕ IPC 通信                               │
│  ┌─────────────────────────────────────────────────────────────┐  │
│  │                    React 渲染进程层                         │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    │  │
│  │  │ UI 组件  │  │ 状态管理 │  │ 路由     │  │ 国际化   │    │  │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘    │  │
│  └─────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────┘
                          ↕ 外部接口
┌──────────────────────────────────────────────────────────────────┐
│                       外部服务与资源                              │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐         │
│  │ AI APIs  │  │ MCP 服务 │  │本地文件  │  │ 技能插件 │         │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘         │
└──────────────────────────────────────────────────────────────────┘
```

### 技术选型理由

| 技术 | 选择理由 | 替代方案 |
|------|----------|----------|
| Electron | 跨平台桌面应用成熟方案 | Tauri, NW.js |
| React 19 | 最新特性和性能优化 | Vue, Svelte |
| TypeScript | 类型安全，提升代码质量 | JavaScript, Flow |
| Zustand | 轻量级状态管理 | Redux, MobX |
| TailwindCSS 4 | 快速 UI 开发 | styled-components, CSS Modules |
| better-sqlite3 | 高性能同步数据库 | SQLite3, LowDB |
| Memvid SDK | 向量数据库，语义搜索 | Pinecone, Weaviate |

---

## 架构设计原则

### 1. 关注点分离 (Separation of Concerns)

- **主进程**: 业务逻辑、数据持久化、系统调用
- **渲染进程**: UI 渲染、用户交互
- **共享层**: 类型定义、工具函数

### 2. 单一职责原则 (Single Responsibility)

每个模块只负责一个功能领域：

```typescript
// ✅ 好的设计 - 单一职责
class ConfigStore {
  save(config: ApiConfig): void {}
  load(): ApiConfig {}
}

class SessionManager {
  create(): Session {}
  delete(id: string): void {}
}

// ❌ 不好的设计 - 职责混乱
class Manager {
  saveConfig(): void {}
  createSession(): void {}
  sendMessage(): void {}
}
```

### 3. 依赖倒置原则 (Dependency Inversion)

高层模块不依赖低层模块，都依赖抽象：

```typescript
// 定义存储接口
interface IStorage {
  save(key: string, value: any): void;
  load(key: string): any;
}

// 实现
class MemvidStorage implements IStorage {
  save(key: string, value: any): void { /* 实现 */ }
}

class FileSystemStorage implements IStorage {
  save(key: string, value: any): void { /* 实现 */ }
}

// 使用
class MemoryService {
  constructor(private storage: IStorage) {}
}
```

### 4. 开闭原则 (Open-Closed)

对扩展开放，对修改关闭：

```typescript
// 技能系统 - 易于扩展
interface Skill {
  name: string;
  execute(context: Context): Promise<Result>;
}

// 添加新技能无需修改核心代码
class MyCustomSkill implements Skill {
  name = 'custom-skill';
  async execute(context: Context): Promise<Result> {
    // 自定义逻辑
  }
}
```

---

## 分层架构

### 1. 表现层 (Presentation Layer)

**位置**: `src/ui/`

**职责**:
- UI 组件渲染
- 用户交互处理
- 状态管理

**核心模块**:
```
src/ui/
├── components/          # 通用 UI 组件
│   ├── MessageList/    # 消息列表组件
│   ├── InputArea/      # 输入区域组件
│   └── Sidebar/        # 侧边栏组件
├── pages/              # 页面组件
│   ├── ChatPage/       # 聊天页面
│   └── SettingsPage/   # 设置页面
├── store/              # Zustand 状态管理
│   └── useAppStore.ts  # 全局状态
└── hooks/              # 自定义 Hooks
    ├── useIPC.ts       # IPC 通信
    └── useMessageWindow.ts
```

### 2. 业务逻辑层 (Business Logic Layer)

**位置**: `src/electron/libs/`

**职责**:
- API 配置管理
- 会话管理
- 记忆系统
- 技能/代理/MCP 管理

**核心模块**:
```
src/electron/libs/
├── config-store.ts      # API 配置
├── session-store.ts     # 会话管理
├── memory-tools.ts      # 记忆系统
├── skills-store.ts      # 技能管理
├── agents-store.ts      # 代理管理
├── mcp-store.ts         # MCP 服务器
├── hooks-store.ts       # 钩子系统
└── permissions-store.ts # 权限管理
```

### 3. 数据访问层 (Data Access Layer)

**位置**: `src/electron/libs/` (stores)

**职责**:
- 文件 I/O
- 数据库操作
- 数据持久化

**存储实现**:
```
存储后端
├── MemvidStore        # Memvid 向量数据库
├── FileSystemStore    # 文件系统存储
├── SessionStore       # 会话持久化
└── ConfigStore        # 配置文件管理
```

### 4. 系统层 (System Layer)

**位置**: `src/electron/`

**职责**:
- IPC 通信
- 窗口管理
- 系统调用
- 日志记录

**核心模块**:
```
src/electron/
├── main.ts              # 主进程入口
├── ipc-handlers.ts      # IPC 事件处理
├── logger.ts            # 日志系统
├── error-handling.ts    # 错误处理
└── api-proxy/           # API 代理
    ├── index.ts         # 代理入口
    ├── server.ts        # SSE 服务器
    └── token-counter.ts # Token 计数
```

---

## 数据流设计

### 1. 用户消息发送流程

```
┌──────────┐
│ 用户输入 │
└─────┬────┘
      │ 1. 用户在输入框输入消息
      ↓
┌──────────────────┐
│  InputArea 组件  │
└─────┬────────────┘
      │ 2. 触发 sendMessage(msg)
      ↓
┌──────────────────┐
│ useAppStore      │
│ (状态管理)        │
└─────┬────────────┘
      │ 3. 更新本地状态
      ↓
┌──────────────────┐
│ useIPC Hook      │
└─────┬────────────┘
      │ 4. 调用 IPC: client-event
      ↓
┌──────────────────┐
│ IPC Main Handler │
└─────┬────────────┘
      │ 5. 处理 client-event
      ↓
┌──────────────────┐
│ API Proxy        │
└─────┬────────────┘
      │ 6. 创建 SSE 服务器
      ↓
┌──────────────────┐
│ AI API           │
└─────┬────────────┘
      │ 7. 流式返回响应
      ↓
┌──────────────────┐
│ Server Event     │
└─────┬────────────┘
      │ 8. 推送到渲染进程
      ↓
┌──────────────────┐
│ MessageList 组件 │
└──────────────────┘
```

### 2. 配置保存流程

```
┌──────────────┐
│ 设置表单     │
└──────┬───────┘
       │ 1. 用户填写配置
       ↓
┌──────────────┐
│ 验证表单     │
└──────┬───────┘
       │ 2. 前端验证
       ↓
┌──────────────┐
│ IPC: save    │
│ api-config   │
└──────┬───────┘
       │ 3. 发送到主进程
       ↓
┌──────────────┐
│ ConfigStore  │
└──────┬───────┘
       │ 4. 验证配置
       ↓
┌──────────────┐
│ 写入 JSON    │
│ 文件         │
└──────┬───────┘
       │ 5. 持久化
       ↓
┌──────────────┐
│ 返回结果     │
└──────────────┘
```

### 3. 记忆查询流程

```
┌──────────────┐
│ 用户提问     │
└──────┬───────┘
       │ 1. 发送消息
       ↓
┌──────────────┐
│ Claude SDK   │
└──────┬───────┘
       │ 2. 检测到 memory_search
       ↓
┌──────────────┐
│ Memory Tools │
└──────┬───────┘
       │ 3. 查询向量数据库
       ↓
┌──────────────┐
│ Memvid Store │
└──────┬───────┘
       │ 4. 返回相似文档
       ↓
┌──────────────┐
│ 组装上下文    │
└──────┬───────┘
       │ 5. 添加到消息历史
       ↓
┌──────────────┐
│ 继续对话     │
└──────────────┘
```

---

## 核心模块架构

### 1. API 配置模块

```typescript
┌─────────────────────────────────────────────┐
│           API Configuration Module         │
│                                             │
│  ┌─────────────┐    ┌─────────────────┐   │
│  │ ConfigStore │ ←→ │ API Adapter     │   │
│  └─────────────┘    └─────────────────┘   │
│         ↓                   ↓              │
│  ┌─────────────┐    ┌─────────────────┐   │
│  │ File System │    │ Provider Configs│   │
│  └─────────────┘    └─────────────────┘   │
└─────────────────────────────────────────────┘
```

**关键设计**:
- 配置版本控制（迁移旧格式）
- 多配置管理（支持切换）
- 配置验证（Zod schema）
- 环境变量同步

### 2. 会话管理模块

```typescript
┌─────────────────────────────────────────────┐
│            Session Management               │
│                                             │
│  ┌──────────┐    ┌──────────┐    ┌──────┐ │
│  │ Session  │ ←→ │ Message  │ ←→ │Store │ │
│  │ Manager  │    │ Queue    │    │      │ │
│  └──────────┘    └──────────┘    └──────┘ │
│       ↓                                  │
│  ┌──────────┐                            │
│  │ Recovery │                            │
│  │ System   │                            │
│  └──────────┘                            │
└─────────────────────────────────────────────┘
```

**关键设计**:
- 会话自动保存
- 消息队列（流式传输）
- 会话恢复机制
- 标题自动生成

### 3. 记忆系统模块

```typescript
┌───────────────────────────────────────────────┐
│             Memory System                     │
│                                                │
│  ┌────────────┐    ┌──────────────────┐      │
│  │ Memory     │ ←→ │  Storage Backend  │      │
│  │ Tools      │    │  - Memvid         │      │
│  └────────────┘    │  - FileSystem     │      │
│       ↓            └──────────────────┘      │
│  ┌────────────┐                              │
│  │ Memvid     │                              │
│  │ SDK        │                              │
│  └────────────┘                              │
└───────────────────────────────────────────────┘
```

**双后端设计**:
- **Memvid 后端**: 高性能向量搜索
- **FileSystem 后端**: 简单文件存储
- 后端切换通过配置实现
- 统一的抽象接口

### 4. 技能系统模块

```typescript
┌─────────────────────────────────────────────┐
│            Skills System                    │
│                                             │
│  ┌──────────┐    ┌──────────┐    ┌──────┐ │
│  │ Skill    │ ←→ │ Metadata │ ←→ │Tags  │ │
│  │ Store    │    │ Store    │    │      │ │
│  └──────────┘    └──────────┘    └──────┘ │
│       ↓                                  │
│  ┌──────────┐                            │
│  │ Skill    │                            │
│  │ Executor │                            │
│  └──────────┘                            │
└─────────────────────────────────────────────┘
```

**关键设计**:
- 技能元数据管理
- 标签分类系统
- 提示词模板引擎
- 脚本执行支持（JavaScript/Python）

### 5. MCP 服务器模块

```typescript
┌─────────────────────────────────────────────┐
│           MCP Integration                   │
│                                             │
│  ┌──────────┐    ┌──────────┐    ┌──────┐ │
│  │ MCP      │ ←→ │ Template │ ←→ │Config│ │
│  │ Store    │    │ System   │    │      │ │
│  └──────────┘    └──────────┘    └──────┘ │
│       ↓                                  │
│  ┌──────────┐                            │
│  │ MCP      │                            │
│  │ Client   │                            │
│  └──────────┘                            │
└─────────────────────────────────────────────┘
```

**关键设计**:
- 服务器生命周期管理
- 预设模板系统
- 动态工具注册
- 错误处理和重试

---

## 存储架构

### 1. 文件系统结构

```
应用数据目录
├── api-config.json           # API 配置
├── sessions/                 # 会话存储
│   ├── {sessionId}.json
│   └── ...
├── memory/                   # 记忆存储（文件系统后端）
│   ├── documents/
│   │   ├── {docId}.json
│   │   └── ...
│   └── index.json
├── mcp-servers.json          # MCP 服务器配置
├── agents/                   # 代理配置
│   ├── global.json
│   ├── orchestration.json
│   └── agents/
│       ├── {agentId}.json
│       └── ...
├── skills-metadata.json      # 技能元数据
├── tags.json                 # 标签数据
├── hooks.json                # 钩子配置
├── permissions.json          # 权限规则
├── output.json               # 输出配置
└── logs/                     # 日志文件
    ├── error.log
    ├── combined.log
    └── exceptions.log
```

### 2. 数据库设计 (Memvid)

**向量表**:
```sql
-- 文档向量表
CREATE TABLE memory_vectors (
  id TEXT PRIMARY KEY,
  title TEXT NOT NULL,
  content TEXT NOT NULL,
  label TEXT,
  metadata TEXT,  -- JSON
  embedding BLOB,  -- 向量数据
  created_at INTEGER,
  updated_at INTEGER
);

-- 向量索引（HNSW）
CREATE INDEX idx_vectors_embedding
ON memory_vectors USING hnsw(embedding vector_cosine_ops);
```

**元数据表**:
```sql
-- 标签表
CREATE TABLE tags (
  id TEXT PRIMARY KEY,
  name TEXT UNIQUE NOT NULL,
  color TEXT NOT NULL
);

-- 技能-标签关联表
CREATE TABLE skill_tags (
  skill_name TEXT NOT NULL,
  tag_id TEXT NOT NULL,
  PRIMARY KEY (skill_name, tag_id),
  FOREIGN KEY (tag_id) REFERENCES tags(id)
);
```

### 3. 数据流

```
┌──────────────┐
│  应用启动    │
└──────┬───────┘
       │
       ↓
┌──────────────┐
│ 加载配置     │
│ - API 配置   │
│ - MCP 服务器 │
│ - 技能列表   │
└──────┬───────┘
       │
       ↓
┌──────────────┐
│ 初始化存储   │
│ - 连接数据库 │
│ - 加载索引   │
└──────┬───────┘
       │
       ↓
┌──────────────┐
│ 运行时       │
│ - 读写数据   │
│ - 更新缓存   │
└──────┬───────┘
       │
       ↓
┌──────────────┐
│ 应用关闭     │
│ - 保存状态   │
│ - 关闭连接   │
└──────────────┘
```

---

## 安全设计

### 1. CSP (Content Security Policy)

```typescript
// 开发环境：宽松策略
const devCSP = "default-src 'self' 'unsafe-inline' 'unsafe-eval' http://localhost:*;";

// 生产环境：严格策略
const prodCSP = "default-src 'self'; " +
  "script-src 'self'; " +
  "style-src 'self' 'unsafe-inline'; " +
  "img-src 'self' data: https:; " +
  "connect-src 'self' https://api.anthropic.com;";
```

### 2. 上下文隔离 (Context Isolation)

```typescript
// preload.ts - 安全桥接
contextBridge.exposeInMainWorld('electronAPI', {
  // 只暴露必要的 API
  getApiConfig: () => ipcRenderer.invoke('get-api-config'),
  saveApiConfig: (config) => ipcRenderer.invoke('save-api-config', config),
  // 不暴露危险的 Node.js API
});
```

### 3. API Key 保护

```typescript
// 存储加密（可选）
export function encryptApiKey(key: string): string {
  const cipher = crypto.createCipher('aes-256-cbc', app.getPath('userData'));
  return cipher.update(key, 'utf8', 'hex') + cipher.final('hex');
}

// 日志脱敏
function sanitizeLog(message: string): string {
  return message.replace(/sk-[a-zA-Z0-9-]{36}/g, 'sk-***');
}
```

### 4. 权限验证

```typescript
// 权限检查中间件
export function checkPermission(toolName: string): boolean {
  const rules = loadPermissionRules();
  const rule = rules.find(r => r.tool === toolName);
  return rule?.allowed ?? true;  // 默认允许
}

// 在工具调用前检查
if (!checkPermission('Write')) {
  throw new Error('Permission denied: Write tool is blocked');
}
```

---

## 性能优化

### 1. 消息流式传输

```typescript
// SSE 流式传输
async function* streamMessages(messages: Message[]) {
  for await (const chunk of api.stream(messages)) {
    yield chunk;  // 逐块返回
  }
}

// 前端实时渲染
for await (const chunk of streamMessages(messages)) {
  updateMessage(chunk);  // 增量更新
}
```

### 2. 数据库连接池

```typescript
// Memvid 连接复用
class MemvidPool {
  private static instance: MemvidStore | null = null;

  static getInstance(): MemvidStore {
    if (!this.instance) {
      this.instance = new MemvidStore(dbPath);
    }
    return this.instance;
  }
}
```

### 3. 虚拟滚动

```typescript
// 大量消息列表优化
import { useVirtualizer } from '@tanstack/react-virtual';

function MessageList({ messages }) {
  const virtualizer = useVirtualizer({
    count: messages.length,
    getScrollElement: () => parentRef.current,
    estimateSize: () => 100,  // 估计高度
    overscan: 5  // 预渲染数量
  });

  // 只渲染可见项
  return virtualizer.getVirtualItems().map(item => (
    <Message key={item.key} data={messages[item.index]} />
  ));
}
```

### 4. 缓存策略

```typescript
// 配置缓存
class ConfigCache {
  private cache: Map<string, ApiConfig> = new Map();

  get(id: string): ApiConfig | undefined {
    return this.cache.get(id);
  }

  set(id: string, config: ApiConfig): void {
    this.cache.set(id, config);
  }

  invalidate(): void {
    this.cache.clear();
  }
}
```

---

## 扩展性设计

### 1. 插件系统架构

```typescript
// 插件接口
interface Plugin {
  name: string;
  version: string;
  init(): Promise<void>;
  destroy(): Promise<void>;
}

// 插件加载器
class PluginLoader {
  private plugins: Map<string, Plugin> = new Map();

  async load(plugin: Plugin): Promise<void> {
    await plugin.init();
    this.plugins.set(plugin.name, plugin);
  }

  async unload(name: string): Promise<void> {
    const plugin = this.plugins.get(name);
    if (plugin) {
      await plugin.destroy();
      this.plugins.delete(name);
    }
  }
}
```

### 2. 技能扩展机制

```typescript
// 技能注册
interface SkillRegistry {
  register(skill: Skill): void;
  unregister(name: string): void;
  get(name: string): Skill | undefined;
  list(): Skill[];
}

// 动态加载技能
async function loadSkillFromFile(path: string): Promise<Skill> {
  const content = await fs.readFile(path, 'utf-8');
  const frontmatter = parseFrontmatter(content);
  return {
    name: frontmatter.name,
    description: frontmatter.description,
    prompt: content,
    // ...
  };
}
```

### 3. MCP 服务器集成

```typescript
// MCP 客户端抽象
interface IMCPClient {
  connect(config: McpServerConfig): Promise<void>;
  disconnect(): Promise<void>;
  listTools(): Promise<Tool[]>;
  callTool(name: string, args: any): Promise<any>;
}

// 支持多种传输方式
class StdioMCPClient implements IMCPClient { /* ... */ }
class SSEMCPClient implements IMCPClient { /* ... */ }
```

### 4. 代理编排系统

```typescript
// 编排策略
interface OrchestrationStrategy {
  execute(agents: Agent[], task: Task): Promise<Result>;
}

// 并行执行
class ParallelStrategy implements OrchestrationStrategy {
  async execute(agents: Agent[], task: Task): Promise<Result> {
    const results = await Promise.allSettled(
      agents.map(agent => agent.execute(task))
    );
    return this.aggregate(results);
  }
}

// 顺序执行
class SequentialStrategy implements OrchestrationStrategy {
  async execute(agents: Agent[], task: Task): Promise<Result> {
    let result = task;
    for (const agent of agents) {
      result = await agent.execute(result);
    }
    return result;
  }
}
```

---

## 监控与日志

### 1. 日志系统设计

```typescript
// 日志级别
enum LogLevel {
  ERROR = 0,
  WARN = 1,
  INFO = 2,
  DEBUG = 3
}

// 结构化日志
interface LogEntry {
  level: LogLevel;
  message: string;
  timestamp: number;
  context?: {
    module: string;
    function: string;
    line: number;
  };
  metadata?: Record<string, any>;
}

// 日志输出
logger.info('API request received', {
  endpoint: '/chat',
  model: 'claude-3-5-sonnet',
  tokenCount: 150
});
```

### 2. 错误处理

```typescript
// 全局错误捕获
process.on('uncaughtException', (error) => {
  logger.error('Uncaught exception', error);
  cleanup();
  app.exit(1);
});

// 错误边界
class ErrorBoundary {
  static handle(error: Error, context: string): void {
    logger.error(`Error in ${context}`, error);
    // 发送错误报告
    sendErrorReport(error, context);
  }
}
```

### 3. 性能监控

```typescript
// 性能指标
class PerformanceMonitor {
  private metrics: Map<string, number[]> = new Map();

  record(operation: string, duration: number): void {
    if (!this.metrics.has(operation)) {
      this.metrics.set(operation, []);
    }
    this.metrics.get(operation)!.push(duration);
  }

  getStats(operation: string): { avg: number; min: number; max: number } {
    const durations = this.metrics.get(operation) || [];
    return {
      avg: durations.reduce((a, b) => a + b, 0) / durations.length,
      min: Math.min(...durations),
      max: Math.max(...durations)
    };
  }
}
```

---

## 未来架构演进

### 1. 微内核架构

```
┌─────────────────────────────────────┐
│           Core Kernel               │
│  - IPC Management                   │
│  - Plugin System                    │
│  - Lifecycle Management             │
└─────────────────────────────────────┘
           ↕           ↕           ↕
┌─────────────┐ ┌─────────────┐ ┌─────────┐
│ AI Module   │ │ Memory Mod  │ │UI Mod   │
└─────────────┘ └─────────────┘ └─────────┘
```

### 2. 云同步支持

```typescript
// 云存储接口
interface CloudStorage {
  sync(): Promise<void>;
  upload(data: ArrayBuffer): Promise<string>;
  download(id: string): Promise<ArrayBuffer>;
}

// 多云支持
class GoogleDriveStorage implements CloudStorage { /* ... */ }
class DropboxStorage implements CloudStorage { /* ... */ }
class OneDriveStorage implements CloudStorage { /* ... */ }
```

### 3. 协作功能

```typescript
// 会话共享
interface SessionShare {
  createShareLink(sessionId: string): Promise<string>;
  joinShare(link: string): Promise<SharedSession>;
  broadcastEvent(event: Event): void;
}
```

---

**最后更新：2026-01-23**
**维护者：AICowork 架构团队**
