# 打包体积优化报告

> **作者**: Alan
> **创建日期**: 2026-01-24
> **邮箱**: none
> **版权**: © 2026 Alan。保留所有权利。
> **许可证**: AGCPA v3.0

---

## 概述

本文档记录了 AICowork 项目 Electron 应用打包体积优化的完整过程。通过三次渐进式优化，将打包体积从预计的 **500MB+** 降低到 **100-200MB** 范围，减少了约 **60-80%** 的体积。

### 文档目的

记录打包优化的完整过程、决策依据和最终配置，为后续维护和类似项目提供参考。

### 目标读者

- Electron 应用开发者
- 需要优化打包体积的前端工程师
- AICowork 项目维护者

---

## 问题诊断

### 初始配置分析

```json
{
    "files": [
        "dist-electron/**/*",
        "dist-react/**/*",
        "templateIcon.ico",
        "node_modules/**/*",              // ❌ 问题根源
        "!node_modules/**/*.ts",
        "!node_modules/**/*.map",
        "!node_modules/**/*.md",
        "!node_modules/**/test/**/*",
        "!node_modules/**/tests/**/*",
        "!node_modules/**/*.d.ts"
    ]
}
```

### 问题根源

| 配置项 | 问题 | 影响 |
|--------|------|------|
| `node_modules/**/*` | 包含**所有**依赖（含 devDependencies） | 体积增加 300-400MB |
| 多余的排除规则 | 即使排除后，基础体积仍巨大 | 无法有效减小 |
| `extraResources` 冗余 | 重复包含已存在的文件 | 增加 5-10MB |
| `asarUnpack` 过度 | 解包纯 JavaScript 模块 | 增加 10-30MB |

### 预估体积对比

| 配置状态 | 预估体积 | 主要原因 |
|---------|---------|---------|
| 优化前 | 500MB+ | 包含 devDependencies |
| 优化后 | 100-200MB | 仅包含生产依赖 |

---

## 优化过程

### 第一阶段：移除 node_modules 通配符

**备份文件**: `RecycleBin/electron-builder.json.backup`

#### 修改内容

```diff
"files": [
    "dist-electron/**/*",
    "dist-react/**/*",
    "templateIcon.ico",
-   "node_modules/**/*",
-   "!node_modules/**/*.ts",
-   "!node_modules/**/*.map",
-   "!node_modules/**/*.md",
-   "!node_modules/**/test/**/*",
-   "!node_modules/**/tests/**/*",
-   "!node_modules/**/*.d.ts"
],
```

#### 优化原理

electron-builder 会自动处理 `package.json` 中 `dependencies` 的依赖，无需显式声明 `node_modules/**/*`。

#### 预期收益

减少约 **300-400MB**

---

### 第二阶段：清理冗余配置

**备份文件**: `RecycleBin/electron-builder.json.backup2`

#### 修改 1：移除 extraResources 冗余

```diff
"extraResources": [
-   "dist-electron/preload.cjs",
-   {
-       "from": "templateIcon.ico",
-       "to": "templateIcon.ico"
-   }
+   ],
```

**原因**: `dist-electron/**/*` 已包含所有文件，无需重复添加。

#### 修改 2：精简 asarUnpack

```diff
"asarUnpack": [
-   "node_modules/@anthropic-ai/claude-agent-sdk/**/*",  // 纯 JS 模块
    "node_modules/better-sqlite3/**/*",
    "node_modules/@memvid/sdk/**/*"
],
```

**模块分析**:

| 模块 | 类型 | 是否需要解包 |
|------|------|-------------|
| `better-sqlite3` | 原生模块 (.node) | ✅ 必须 |
| `@memvid/sdk` | 原生模块 (多平台 .node) | ✅ 必须 |
| `@anthropic-ai/claude-agent-sdk` | 纯 JavaScript | ❌ 不需要 |

#### 预期收益

减少约 **10-30MB**

---

### 第三阶段：最佳实践优化

**备份文件**: `RecycleBin/electron-builder.json.backup3`

#### 修改 1：添加排除规则

```diff
"files": [
    "dist-electron/**/*",
    "dist-react/**/*",
    "templateIcon.ico",
+   "!**/*.map",
+   "!**/*.test.*",
+   "!**/*.spec.*"
],
```

#### 修改 2：精简 asarUnpack（仅解包二进制文件）

```diff
"asarUnpack": [
-   "node_modules/better-sqlite3/**/*",
+   "node_modules/better-sqlite3/build/**/*.node",
-   "node_modules/@memvid/sdk/**/*"
+   "node_modules/@memvid/sdk/**/*.node"
],
```

**验证命令**:
```bash
# 确认原生模块位置
ls node_modules/better-sqlite3/build/Release/
# 输出: better_sqlite3.node

ls node_modules/@memvid/sdk/*.node
# 输出: 多平台的 .node 文件
```

#### 修改 3：移除冗余 icon 配置

```diff
"win": {
-   "icon": "./templateIcon.ico",  // 顶层已设置
    "signAndEditExecutable": false,
    "target": ["portable"]
}
```

#### 预期收益

进一步减少 **5-15MB**

---

## 最终配置

### electron-builder.json

```json
{
    "appId": "com.devagentforge.aicowork",
    "productName": "AICowork",
    "compression": "maximum",
    "files": [
        "dist-electron/**/*",
        "dist-react/**/*",
        "templateIcon.ico",
        "!**/*.map",
        "!**/*.test.*",
        "!**/*.spec.*"
    ],
    "extraResources": [],
    "npmRebuild": false,
    "asarUnpack": [
        "node_modules/better-sqlite3/build/**/*.node",
        "node_modules/@memvid/sdk/**/*.node"
    ],
    "icon": "./templateIcon.ico",
    "mac": {
        "target": "dmg"
    },
    "linux": {
        "target": "AppImage",
        "category": "Utility"
    },
    "win": {
        "signAndEditExecutable": false,
        "target": ["portable"]
    }
}
```

### 配置说明

| 配置项 | 值 | 说明 |
|--------|-----|------|
| `compression` | `maximum` | 使用最大压缩算法 |
| `files` | 精简列表 | 仅包含必要文件，排除测试和 sourcemap |
| `extraResources` | `[]` | 无额外资源需求 |
| `npmRebuild` | `false` | 禁用自动重建（使用手动 rebuild 脚本） |
| `asarUnpack` | 精确路径 | 仅解包原生二进制文件 |

---

## 优化结果汇总

### 体积对比

| 阶段 | 预估体积 | 减少量 |
|------|---------|--------|
| 初始状态 | 500MB+ | - |
| 第一阶段 | 150-250MB | ~300MB |
| 第二阶段 | 140-230MB | ~10MB |
| 第三阶段 | 100-200MB | ~30MB |
| **总减少** | - | **60-80%** |

### 配置对比

| 项目 | 优化前 | 优化后 |
|------|--------|--------|
| files 条目数 | 9 条 | 6 条 |
| extraResources | 2 项 | 0 项 |
| asarUnpack 条目 | 3 个全量解包 | 2 个精确解包 |
| 冗余配置 | 有 | 无 |

---

## 验证方法

### 打包测试

```bash
# Windows
pnpm dist:win

# macOS ARM64
pnpm dist:mac-arm64

# macOS x64
pnpm dist:mac-x64

# Linux
pnpm dist:linux
```

### 检查打包内容

```bash
# 列出 asar 包内容
npx asar list dist/win-unpacked/resources/app.asar

# 检查 asarUnpack 目录
ls dist/win-unpacked/resources/app.asar.unpacked/node_modules/
```

### 体积对比

```bash
# 查看最终体积
du -sh dist/win-unpacked/

# Windows PowerShell
Get-ChildItem dist\ -Recurse | Measure-Object -Property Length -Sum
```

---

## 问题排查与恢复

### 备份文件说明

每次优化前都创建了备份文件，存放在 `RecycleBin/` 目录：

| 备份文件 | 对应阶段 | 配置状态 |
|---------|---------|---------|
| `electron-builder.json.backup` | 第一阶段优化前 | 初始配置（含 node_modules/**/*） |
| `electron-builder.json.backup2` | 第二阶段优化前 | 已移除 node_modules，含冗余配置 |
| `electron-builder.json.backup3` | 第三阶段优化前 | 已清理冗余，未精简 asarUnpack |

### 配置恢复步骤

如果优化后遇到问题，可以按以下步骤恢复：

#### 方法 1：从备份恢复

```bash
# 查看所有备份
ls RecycleBin/electron-builder.json.backup*

# 恢复到特定版本（例如恢复到初始配置）
cp RecycleBin/electron-builder.json.backup electron-builder.json

# 或恢复到第二阶段后的配置
cp RecycleBin/electron-builder.json.backup2 electron-builder.json
```

#### 方法 2：手动回滚特定配置

如果只想回滚某项配置：

```bash
# 1. 查看备份内容
cat RecycleBin/electron-builder.json.backup

# 2. 手动复制需要的配置段到当前文件
# 例如：恢复 asarUnpack 配置
```

### 常见问题排查

#### 问题 1：打包后应用无法启动

**可能原因**: `asarUnpack` 路径不正确，原生模块未正确解包

**解决方案**:
```bash
# 检查原生模块实际位置
find node_modules/better-sqlite3 -name "*.node"
find node_modules/@memvid/sdk -name "*.node"

# 恢复到上一个可用的配置
cp RecycleBin/electron-builder.json.backup3 electron-builder.json
```

#### 问题 2：模块找不到错误

**可能原因**: 纯 JS 模块被错误地从 asarUnpack 移除

**解决方案**:
```bash
# 如果 claude-agent-sdk 报错，临时恢复它到 asarUnpack
# 编辑 electron-builder.json，添加：
"asarUnpack": [
    "node_modules/better-sqlite3/build/**/*.node",
    "node_modules/@memvid/sdk/**/*.node",
    "node_modules/@anthropic-ai/claude-agent-sdk/**/*"  // 临时添加
]
```

#### 问题 3：打包体积仍然过大

**检查清单**:
```bash
# 1. 确认 node_modules/**/* 已移除
grep "node_modules/\*\*" electron-builder.json

# 2. 检查是否意外包含了 devDependencies
cat package.json | grep -A 50 "devDependencies"

# 3. 查看实际打包内容
npx asar list dist/win-unpacked/resources/app.asar | wc -l
```

#### 问题 4：特定文件缺失

**可能原因**: 排除规则过于宽泛

**解决方案**:
```bash
# 检查排除规则
grep "^\s*\"!" electron-builder.json

# 如果需要特定文件，修改排除规则为更精确的路径
# 例如：!**/*.map → !dist-react/**/*.js.map
```

### 快速回滚命令

```bash
# 紧急回滚到初始配置（已知可用版本）
cp RecycleBin/electron-builder.json.backup electron-builder.json && pnpm dist:win

# 回滚到保守配置（第二阶段后）
cp RecycleBin/electron-builder.json.backup2 electron-builder.json && pnpm dist:win

# 回滚到当前配置的前一版本
cp RecycleBin/electron-builder.json.backup3 electron-builder.json && pnpm dist:win
```

### 验证恢复结果

```bash
# 恢复后检查配置语法
cat electron-builder.json | jq .

# 测试打包（仅构建不发布）
pnpm dist:win

# 检查打包是否成功
ls dist/*.exe 2>/dev/null && echo "打包成功" || echo "打包失败"
```

---

## 最佳实践建议

### ✅ 应该做

1. **依赖分类清晰**
   - 生产依赖放 `dependencies`
   - 开发依赖放 `devDependencies`

2. **让 electron-builder 自动处理**
   - 不显式声明 `node_modules/**/*`
   - 信任依赖管理机制

3. **精确解包原生模块**
   - 只解包 `.node` 二进制文件
   - 避免解包纯 JavaScript 模块

4. **启用最大压缩**
   - `"compression": "maximum"`
   - 牺牲少量构建时间换取更小体积

5. **排除调试文件**
   - `!**/*.map`
   - `!**/*.test.*`
   - `!**/*.spec.*`

### ❌ 不应该做

1. **显式包含 node_modules**
   ```json
   // ❌ 错误做法
   "files": ["node_modules/**/*"]
   ```

2. **过度解包**
   ```json
   // ❌ 错误做法
   "asarUnpack": ["node_modules/some-pure-js-package/**/*"]
   ```

3. **重复配置**
   ```json
   // ❌ 错误做法
   "icon": "./icon.ico",
   "win": { "icon": "./icon.ico" }  // 冗余
   ```

---

## 附录

### 备份文件清单

每次优化前都会创建备份，确保出现问题可以快速恢复：

```
RecycleBin/
├── electron-builder.json.backup   # 初始配置（含 node_modules/**/*）
├── electron-builder.json.backup2  # 第二次优化前（已移除 node_modules）
└── electron-builder.json.backup3  # 第三次优化前（已清理冗余）
```

**重要**: 删除这些备份文件前，请确保优化后的配置已通过完整测试。

**恢复方法**: 详见「问题排查与恢复」章节

### 参考资源

- [electron-builder 官方文档](https://www.electron.build/)
- [electron-builder 文件配置](https://www.electron.build/configuration)
- [ASAR 格式说明](https://github.com/electron/asar)

### 关键命令

```bash
# 查看包内容
npx asar list app.asar

# 提取 asar 包
npx asar extract app.asar app-folder

# 打包为 asar
npx asar pack app-folder app.asar
```

---

## 版本记录

| 版本 | 日期 | 变更内容 | 维护者 |
|-----|------|---------|--------|
| 1.1.0 | 2026-01-24 | 新增「问题排查与恢复」章节，完善备份恢复指南 | Alan |
| 1.0.0 | 2026-01-24 | 初始版本，记录三次优化过程 | Alan |

---

**文档版本**: 1.1.0
**创建日期**: 2026-01-24
**最后更新**: 2026-01-24
**维护者**: Alan
**许可证**: AGCPA v3.0
